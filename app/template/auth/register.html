{% extends "base.html" %}

{% block title %} Register {% endblock %}

{% block content %}
    

<div class="modal fade" id="registerBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="registerBackdropLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="registerBackdropLabel">Register</h5>
      </div> 
        <form action="{{ url_for('auth.register') }}" method="post" name="register_user_form" id="register_user_form">
            <div class="modal-body">
                    {{register_user_form.hidden_tag()}}
                    <div class="row my-2 align-items-center">
                        <div class="col-3">
                            <label for="username" class="col-form-label">Identifier</label>
                        </div>    
                        <div class="col-9">
                            {{register_user_form.username(class="form-control")}}
                        </div>
                    </div>    
                    {% for error in register_user_form.errors.username %}
                        <span style="color: red;">[{{error}}]</span>
                    {% endfor %}
                    <div class="row my-2 align-items-center">
                        <div class="col-3">
                            <label for="fullname" class="col-form-label">Full name</label>
                        </div>    
                        <div class="col-9">
                            {{register_user_form.fullname(class="form-control")}}
                        </div>
                    </div>    
                    {% for error in register_user_form.errors.fullname %}
                        <span style="color: red;">[{{error}}]</span>
                    {% endfor %}
                    <div class="row my-2 align-items-center">
                        <div class="col-3">
                            <label for="email" class="col-form-label">Email</label>
                        </div>    
                        <div class="col-9">
                            {{register_user_form.email(class="form-control")}}
                        </div>
                    </div>    
                    {% for error in register_user_form.errors.email %}
                        <span style="color: red;">[{{error}}]</span>
                    {% endfor %}
                    <div class="row my-2 align-items-center">
                        <div class="col-3">
                            <label for="phone" class="col-form-label">Phone</label>
                        </div>    
                        <div class="col-9">
                            {{register_user_form.phone(class="form-control")}}
                        </div>
                    </div>    
                    {% for error in register_user_form.errors.phone %}
                        <span style="color: red;">[{{error}}]</span>
                    {% endfor %}
                    <div class="row my-2 align-items-center">
                        <div class="col-3">
                            <label for="password1" class="col-form-label">Password</label>
                        </div>    
                        <div class="col-9">
                            {{register_user_form.password1( size=80, class="form-control")}}
                        </div>
                    </div>    
                    {% for error in register_user_form.errors.password1 %}
                        <span style="color: red;">[{{error}}]</span>
                    {% endfor %}
                    <div class="row my-2 align-items-center">
                        <div class="col-3">
                            <label for="password2" class="col-form-label">Confirm password</label>
                        </div>    
                        <div class="col-9">
                            {{register_user_form.password2( size=80, class="form-control")}}
                        </div>
                    </div>    
                    {% for error in register_user_form.errors.password2 %}
                        <span style="color: red;">[{{error}}]</span>
                    {% endfor %}
                    <div class="row my-2 align-items-center">
                        <div class="col-3">
                            <label for="quiz1" class="col-form-label">Question 1</label>
                        </div>    
                        <div class="col-9">
                            {{register_user_form.quiz1(class="form-control")}}
                        </div>
                    </div>    
                    {% for error in register_user_form.errors.quiz1 %}
                        <span style="color: red;">[{{error}}]</span>
                    {% endfor %}
                    <div class="row my-2 align-items-center">
                        <div class="col-3">
                            <label for="ans1" class="col-form-label">Answer 1</label>
                        </div>    
                        <div class="col-9">
                            {{register_user_form.ans1(class="form-control")}}
                        </div>
                    </div>    
                    {% for error in register_user_form.errors.ans1 %}
                        <span style="color: red;">[{{error}}]</span>
                    {% endfor %}
                    <div class="row my-2 align-items-center">
                        <div class="col-3">
                            <label for="quiz2" class="col-form-label">Question 2</label>
                        </div>    
                        <div class="col-9">
                            {{register_user_form.quiz2(class="form-control")}}
                        </div>
                    </div>    
                    {% for error in register_user_form.errors.quiz2 %}
                        <span style="color: red;">[{{error}}]</span>
                    {% endfor %}
                    <div class="row my-2 align-items-center">
                        <div class="col-3">
                            <label for="ans2" class="col-form-label">Answer 2</label>
                        </div>    
                        <div class="col-9">
                            {{register_user_form.ans2(class="form-control")}}
                        </div>
                    </div>    
                    {% for error in register_user_form.errors.ans2 %}
                        <span style="color: red;">[{{error}}]</span>
                    {% endfor %}
                    <div class="row my-2 align-items-center">
                        <div class="col-3">
                            <label for="quiz3" class="col-form-label">Question 2</label>
                        </div>    
                        <div class="col-9">
                            {{register_user_form.quiz3(class="form-control")}}
                        </div>
                    </div>    
                    {% for error in register_user_form.errors.quiz3 %}
                        <span style="color: red;">[{{error}}]</span>
                    {% endfor %}
                    <div class="row my-2 align-items-center">
                        <div class="col-3">
                            <label for="ans3" class="col-form-label">Answer 3</label>
                        </div>    
                        <div class="col-9">
                            {{register_user_form.ans3(class="form-control")}}
                        </div>
                    </div>    
                    {% for error in register_user_form.errors.ans3 %}
                        <span style="color: red;">[{{error}}]</span>
                    {% endfor %}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="location.href='{{url_for('main.home')}}';">Cancel</button>
            <button type="submit" class="btn btn-primary">Submit</button>
          </div>
      </form>
    </div>
  </div>
</div>
<script type="text/javascript">
    /* TODO: Obfuscate it. */
    $(window).on('load', () => {
        const checkexists = (event) => {
            let val = event.target.value;
            if(val !== undefined && val.length > 0){
                doencrypt($("#tag1").val(), 
                    JSON.stringify(
                    {   do: 'exists',
                        what: event.target.name,
                        value: val
                    })    
                    , (data) => {
                    $.ajax({
                        url: '{{url_for("auth.check")}}',
                        type: "POST",
                        data: window.btoa(data),
                        success: (res) => {
                            if(res.exists){
                                console.log(res);
                                bsalert(event.target.name + " already exists, try another one!", "error");
                                event.target.focus();
                            }
                        },
                        error: (xhr, ajaxOptions, thrownError) => {
                            console.log(xhr.status, xhr.statusText, " : ", xhr.responseText);
                        }
                    });
    
                });
            }
        };
        $("#username").on('focusout', checkexists);
        $("#email").on('focusout', checkexists);
        $("#phone").on('focusout', checkexists);
        $("#register_user_form").submit((event) => {
            event.preventDefault();
            if( $("#password1").val() !== $("#password2").val()){
                bsalert("Passwords doesn`t match","error"); 
                return false;
            }
            let tagobj = formobject(event.target); 
            delete tagobj.tag1;
            delete tagobj.tag2;
            delete tagobj.csrf_token;
            const tagstr = JSON.stringify(tagobj);
            console.log(tagstr);
            doencrypt($("#tag1").val(), tagstr, (data) => {
                $("#tag2").val(window.btoa(data));
                $("#username").val(spoil($("#username").val()));
                $("#fullname").val(spoil($("#fullname").val()));
                $("#password1").val(spoil($("#password2").val()));
                $("#password2").val(spoil($("#password1").val()));
                $("#quiz1").val(spoil($("#quiz1").val()));
                $("#ans1").val(spoil($("#ans1").val()));
                $("#quiz2").val(spoil($("#quiz2").val()));
                $("#ans2").val(spoil($("#ans2").val()));
                $("#quiz3").val(spoil($("#quiz3").val()));
                $("#ans3").val(spoil($("#ans3").val()));
                event.currentTarget.submit();
            });
        });
        $('#registerBackdrop').modal('show');
    });
</script>

{% endblock content %}
